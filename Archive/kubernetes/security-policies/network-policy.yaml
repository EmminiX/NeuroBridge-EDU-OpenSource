# NeuroBridge EDU - Network Security Policies
# Educational institution network segmentation and security controls
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: neurobridge-backend-netpol
  namespace: neurobridge-edu
  labels:
    app: neurobridge-edu
    component: backend
    security-policy: network
  annotations:
    description: "Backend network security for educational compliance"
spec:
  podSelector:
    matchLabels:
      app: neurobridge-edu
      component: backend
  
  policyTypes:
  - Ingress
  - Egress
  
  # Backend ingress rules - only from frontend and monitoring
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: neurobridge-edu
          component: frontend
    ports:
    - protocol: TCP
      port: 3939
  
  # Allow monitoring access for educational observability
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    - podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 3939
  
  # Allow health checks from kube-system
  - from:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: TCP
      port: 3939
  
  # Backend egress rules - controlled external access
  egress:
  # DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  
  # HTTPS for OpenAI API (educational API key usage)
  - to: []
    ports:
    - protocol: TCP
      port: 443
  
  # Database access within namespace
  - to:
    - podSelector:
        matchLabels:
          app: neurobridge-edu
          component: database
    ports:
    - protocol: TCP
      port: 5432

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: neurobridge-frontend-netpol
  namespace: neurobridge-edu
  labels:
    app: neurobridge-edu
    component: frontend
    security-policy: network
  annotations:
    description: "Frontend network security for educational web access"
spec:
  podSelector:
    matchLabels:
      app: neurobridge-edu
      component: frontend
  
  policyTypes:
  - Ingress
  - Egress
  
  # Frontend ingress - allow external educational access
  ingress:
  # Allow from anywhere (educational web access)
  - {}
  
  # Frontend egress - only to backend services
  egress:
  # DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  
  # Backend API communication
  - to:
    - podSelector:
        matchLabels:
          app: neurobridge-edu
          component: backend
    ports:
    - protocol: TCP
      port: 3939

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: neurobridge-deny-all-default
  namespace: neurobridge-edu
  labels:
    app: neurobridge-edu
    security-policy: default-deny
  annotations:
    description: "Default deny policy for educational security baseline"
spec:
  podSelector: {}  # Apply to all pods in namespace
  policyTypes:
  - Ingress
  - Egress
  # No rules defined = deny all by default

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: neurobridge-monitoring-access
  namespace: neurobridge-edu
  labels:
    app: neurobridge-edu
    security-policy: monitoring
  annotations:
    description: "Allow monitoring access for educational observability"
spec:
  podSelector:
    matchLabels:
      app: neurobridge-edu
  
  policyTypes:
  - Ingress
  
  ingress:
  # Allow Prometheus scraping from monitoring namespace
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    - podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 3939
    - protocol: TCP
      port: 8080
  
  # Allow logging agents
  - from:
    - namespaceSelector:
        matchLabels:
          name: logging
    - podSelector:
        matchLabels:
          app: fluentd